<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFC Agent Test Client</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            width: 100%;
        }

        h1 {
            font-size: 32px;
            margin-bottom: 8px;
            text-align: center;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 20px;
            font-size: 16px;
        }

        /* Tab navigation */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
        }

        .tab {
            flex: 1;
            padding: 12px 20px;
            text-align: center;
            cursor: pointer;
            background: #f9f9f9;
            border: none;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s;
            color: black;
        }

        .tab:hover {
            background: #eee;
        }

        .tab.active {
            background: #333;
            color: white;
        }

        .tab:not(:last-child) {
            border-right: 1px solid #ddd;
        }

        .section {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 30px;
            margin-bottom: 20px;
        }

        .section h2 {
            font-size: 18px;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .section h3 {
            font-size: 15px;
            margin-bottom: 15px;
            font-weight: 500;
            color: #555;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #999;
        }

        .status-dot.connected {
            background: #22c55e;
            animation: pulse 2s infinite;
        }

        .status-dot.scanning {
            background: #3b82f6;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            font-weight: 500;
        }

        input, select, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        textarea {
            resize: vertical;
            min-height: 60px;
            font-family: inherit;
        }

        button {
            background: #333;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            width: 100%;
        }

        button:hover {
            background: #555;
        }

        button:disabled {
            background: #999;
            cursor: not-allowed;
        }

        button.secondary {
            background: transparent;
            color: #333;
            border: 1px solid #ddd;
        }

        button.secondary:hover {
            background: #f9f9f9;
        }

        button.danger {
            background: #dc2626;
        }

        button.danger:hover {
            background: #b91c1c;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 10px;
            opacity: 0.5;
        }

        .card-data {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 13px;
        }

        .card-data div {
            margin-bottom: 8px;
        }

        .card-data strong {
            display: inline-block;
            width: 100px;
        }

        .record {
            background: #f9f9f9;
            padding: 10px;
            border-left: 3px solid #333;
            margin-bottom: 10px;
        }

        .record-type {
            font-weight: 600;
            font-size: 12px;
            color: #666;
        }

        .raw-dump {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 300px;
            overflow-y: auto;
        }

        .alert {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
        }

        .alert-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .two-col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .log-entry {
            padding: 8px 10px;
            background: #f9f9f9;
            border-radius: 4px;
            margin-bottom: 8px;
            font-size: 13px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .log-entry .time {
            color: #999;
            font-size: 11px;
        }

        .log-entry .source {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 3px;
            background: #e5e7eb;
            color: #6b7280;
        }

        .log-entry .source.webnfc {
            background: #dbeafe;
            color: #1d4ed8;
        }

        .write-request-item {
            padding: 15px;
            background: #fef3c7;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .write-request-item .request-id {
            font-size: 11px;
            color: #92400e;
            margin-bottom: 5px;
        }

        .write-request-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .write-request-actions button {
            flex: 1;
            padding: 8px;
        }

        @media (max-width: 600px) {
            h1 {
                font-size: 24px;
            }

            .section {
                padding: 20px;
            }

            .two-col {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="app" class="container">
        <h1>NFC Agent Test Client</h1>

        <!-- Tab Navigation -->
        <div class="tabs">
            <button class="tab" :class="{ active: mode === 'client' }" @click="switchMode('client')">
                Client
            </button>
            <button class="tab" :class="{ active: mode === 'device' }" @click="switchMode('device')">
                Device
            </button>
        </div>

        <!-- Consumer Mode -->
        <div v-show="mode === 'client'">
            <!-- State 1: Landing / Connection -->
            <template v-if="clientState === 'landing'">
                <p class="subtitle">Connect to receive NFC data</p>

                <div class="section">
                    <div v-if="clientError" class="alert alert-error">{{ clientError }}</div>

                    <div class="form-group">
                        <label>Client Server URL</label>
                        <input type="text" v-model="clientUrl" :disabled="clientConnecting">
                    </div>
                    <div class="form-group">
                        <label>API Secret (optional)</label>
                        <input type="password" v-model="apiSecret" placeholder="Enter API secret" :disabled="clientConnecting">
                    </div>
                    <button @click="connectClient" :disabled="clientConnecting">
                        {{ clientConnecting ? 'Connecting...' : 'Connect' }}
                    </button>
                </div>
            </template>

            <!-- State 2: Connected / Ready to scan -->
            <template v-else-if="clientState === 'scan'">
                <p class="subtitle">Ready to receive</p>

                <div class="section">
                    <div class="status">
                        <div class="status-dot connected"></div>
                        <span>Connected to ClientServer</span>
                    </div>

                    <div class="empty-state">
                        <div class="empty-icon">ðŸ“±</div>
                        <div>Waiting for tag data...</div>
                    </div>

                    <button class="secondary" @click="disconnectClient">Disconnect</button>
                </div>
            </template>

            <!-- State 3: Card detected -->
            <template v-else-if="clientState === 'card'">
                <p class="subtitle">{{ card.uid }}</p>

                <!-- Card Info -->
                <div class="section">
                    <h2>Card Information</h2>
                    <div class="card-data">
                        <div><strong>UID:</strong> {{ card.uid }}</div>
                        <div><strong>Type:</strong> {{ card.type || 'Unknown' }}</div>
                        <div v-if="card.technology"><strong>Technology:</strong> {{ card.technology }}</div>
                        <div v-if="card.scannedAt"><strong>Scanned:</strong> {{ formatDate(card.scannedAt) }}</div>
                    </div>
                </div>

                <!-- Records -->
                <div class="section" v-if="card.records && card.records.length > 0">
                    <h2>NDEF Records</h2>
                    <div v-for="(record, index) in card.records" :key="index" class="record">
                        <div class="record-type">{{ record.type.toUpperCase() }} (TNF: {{ record.tnf }}) [{{ index }}]</div>
                        <div>{{ record.content || '(Binary Data)' }}</div>
                        <div v-if="record.language" style="font-size: 11px; color: #999; margin-top: 5px;">Language: {{ record.language }}</div>
                    </div>
                </div>

                <!-- Raw Payload -->
                <div class="section">
                    <h2>Raw Payload</h2>
                    <pre class="raw-dump">{{ JSON.stringify(rawPayload, null, 2) }}</pre>
                </div>

                <!-- Write -->
                <div class="section">
                    <h2>Write to Card</h2>

                    <div v-if="writeStatus.message" :class="['alert', writeStatus.type]">
                        {{ writeStatus.message }}
                    </div>

                    <div class="form-group">
                        <label>Content</label>
                        <textarea v-model="writeForm.content" :disabled="writeStatus.writing" placeholder="Enter text or URI to write"></textarea>
                    </div>

                    <div class="form-group">
                        <label>Record Type</label>
                        <select v-model="writeForm.type" :disabled="writeStatus.writing">
                            <option value="text">Text</option>
                            <option value="uri">URI</option>
                        </select>
                    </div>

                    <div class="alert alert-info">
                        <strong>Note:</strong> Writing will overwrite all existing records on the card.
                    </div>

                    <button @click="writeCard" :disabled="writeStatus.writing || !writeForm.content.trim()">
                        {{ writeStatus.writing ? 'Writing...' : 'Write to Card' }}
                    </button>
                </div>

                <button class="secondary" @click="backToScan">Back to Scan</button>
            </template>
        </div>

        <!-- Device Mode -->
        <div v-show="mode === 'device'">
            <!-- Connection Section -->
            <template v-if="deviceState === 'disconnected'">
                <p class="subtitle">Connect as NFC device</p>

                <div class="section">
                    <div v-if="deviceError" class="alert alert-error">{{ deviceError }}</div>

                    <div class="form-group">
                        <label>Device Server URL</label>
                        <input type="text" v-model="deviceUrl" :disabled="deviceConnecting">
                    </div>
                    <div class="form-group">
                        <label>Device Name</label>
                        <input type="text" v-model="deviceName" :disabled="deviceConnecting" placeholder="My Browser Device">
                    </div>
                    <button @click="connectDevice" :disabled="deviceConnecting">
                        {{ deviceConnecting ? 'Connecting...' : 'Connect as Device' }}
                    </button>
                </div>
            </template>

            <!-- Connected State -->
            <template v-else>
                <p class="subtitle">Device: {{ deviceID }}</p>

                <!-- Connection Status -->
                <div class="section">
                    <div class="status">
                        <div class="status-dot connected"></div>
                        <span>Connected as device</span>
                    </div>
                    <div class="card-data">
                        <div><strong>Device ID:</strong> {{ deviceID }}</div>
                        <div><strong>Server:</strong> {{ serverInfo?.version || 'Unknown' }}</div>
                    </div>
                    <button class="secondary" @click="disconnectDevice" style="margin-top: 15px;">Disconnect</button>
                </div>

                <!-- WebNFC Scanner -->
                <div class="section">
                    <h2>WebNFC Scanner</h2>

                    <template v-if="webNFCSupported">
                        <div v-if="nfcScanning" class="status">
                            <div class="status-dot scanning"></div>
                            <span>Scanning for NFC tags...</span>
                        </div>

                        <div class="two-col" style="margin-bottom: 15px;">
                            <button @click="startNFCScanning" :disabled="nfcScanning">
                                Start Scanning
                            </button>
                            <button class="secondary" @click="stopNFCScanning" :disabled="!nfcScanning">
                                Stop Scanning
                            </button>
                        </div>

                        <div v-if="nfcError" class="alert alert-error">{{ nfcError }}</div>
                    </template>

                    <template v-else>
                        <div class="alert alert-warning">
                            WebNFC is not supported in this browser. WebNFC requires Chrome 89+ on Android with HTTPS or localhost.
                        </div>
                    </template>
                </div>

                <!-- Manual Tag Input -->
                <div class="section">
                    <h2>Manual Tag Input</h2>
                    <p style="font-size: 13px; color: #666; margin-bottom: 15px;">For testing without physical NFC hardware</p>

                    <div class="form-group">
                        <label>Tag UID</label>
                        <input type="text" v-model="manualTag.uid" placeholder="04:AB:CD:EF:12:34:56">
                    </div>

                    <div class="two-col">
                        <div class="form-group">
                            <label>Type</label>
                            <select v-model="manualTag.type">
                                <option value="MIFARE Classic 1K">MIFARE Classic 1K</option>
                                <option value="MIFARE Classic 4K">MIFARE Classic 4K</option>
                                <option value="MIFARE Ultralight">MIFARE Ultralight</option>
                                <option value="MIFARE DESFire">MIFARE DESFire</option>
                                <option value="NTAG213">NTAG213</option>
                                <option value="NTAG215">NTAG215</option>
                                <option value="NTAG216">NTAG216</option>
                                <option value="Type 4 Tag">Type 4 Tag</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Technology</label>
                            <select v-model="manualTag.technology">
                                <option value="ISO14443A">ISO14443A</option>
                                <option value="ISO14443B">ISO14443B</option>
                                <option value="ISO15693">ISO15693</option>
                                <option value="NFC-F">NFC-F</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>NDEF Text Content (optional)</label>
                        <textarea v-model="manualTag.ndefText" placeholder="Enter NDEF text content"></textarea>
                    </div>

                    <div class="two-col">
                        <button @click="sendManualScan" :disabled="!manualTag.uid.trim()">
                            Scan Tag
                        </button>
                        <button class="danger" @click="sendManualRemove" :disabled="!lastScannedUID">
                            Remove Tag
                        </button>
                    </div>
                </div>

                <!-- Incoming Write Requests -->
                <div class="section">
                    <h2>Incoming Write Requests</h2>

                    <template v-if="writeRequests.length > 0">
                        <div v-for="req in writeRequests" :key="req.requestID" class="write-request-item">
                            <div class="request-id">Request ID: {{ req.requestID }}</div>
                            <div v-if="req.ndefMessage">
                                <strong>NDEF Message:</strong>
                                <pre style="font-size: 11px; margin-top: 5px;">{{ JSON.stringify(req.ndefMessage, null, 2) }}</pre>
                            </div>
                            <div class="write-request-actions">
                                <button @click="respondWrite(req.requestID, true)">Success</button>
                                <button class="danger" @click="respondWrite(req.requestID, false, 'Write failed')">Fail</button>
                            </div>
                        </div>
                    </template>

                    <template v-else>
                        <div style="text-align: center; color: #999; padding: 20px;">
                            No pending write requests
                        </div>
                    </template>
                </div>

                <!-- Scanned Tags Log -->
                <div class="section">
                    <h2>Scanned Tags Log</h2>

                    <template v-if="scanLog.length > 0">
                        <div v-for="(entry, index) in scanLog" :key="index" class="log-entry">
                            <div>
                                <strong>{{ entry.uid }}</strong>
                                <span :class="['source', entry.source]">{{ entry.source }}</span>
                            </div>
                            <span class="time">{{ entry.time }}</span>
                        </div>
                        <button class="secondary" @click="clearScanLog" style="margin-top: 10px;">Clear Log</button>
                    </template>

                    <template v-else>
                        <div style="text-align: center; color: #999; padding: 20px;">
                            No tags scanned yet
                        </div>
                    </template>
                </div>
            </template>
        </div>
    </div>

    <script src="./nfc-client.js"></script>
    <script src="./nfc-device-client.js"></script>
    <script>
        const { createApp, ref, reactive, computed, onMounted } = Vue;

        createApp({
            setup() {
                // Mode: 'client' or 'device'
                const mode = ref('client');

                // ==================== Client Mode State ====================
                const clientState = ref('landing');
                const clientUrl = ref('http://localhost:9471');
                const apiSecret = ref('');
                const clientConnecting = ref(false);
                const clientError = ref('');

                let nfcClient = null;

                const card = reactive({
                    uid: '',
                    type: '',
                    technology: '',
                    scannedAt: null,
                    records: []
                });

                const rawPayload = ref(null);

                const writeForm = reactive({
                    content: '',
                    type: 'text'
                });

                const writeStatus = reactive({
                    writing: false,
                    message: '',
                    type: ''
                });

                // ==================== Device Mode State ====================
                const deviceState = ref('disconnected');
                const deviceUrl = ref('ws://localhost:9470');
                const deviceName = ref('Browser NFC Device');
                const deviceConnecting = ref(false);
                const deviceError = ref('');
                const deviceID = ref('');
                const serverInfo = ref(null);

                let deviceClient = null;

                // WebNFC state
                const webNFCSupported = ref(false);
                const nfcScanning = ref(false);
                const nfcError = ref('');

                // Manual tag input
                const manualTag = reactive({
                    uid: '',
                    type: 'MIFARE Classic 1K',
                    technology: 'ISO14443A',
                    ndefText: ''
                });

                const lastScannedUID = ref('');

                // Write requests from server
                const writeRequests = ref([]);

                // Scan log
                const scanLog = ref([]);

                // ==================== Mode Switching ====================
                function switchMode(newMode) {
                    mode.value = newMode;
                }

                // ==================== Client Mode Functions ====================
                async function connectClient() {
                    clientConnecting.value = true;
                    clientError.value = '';

                    try {
                        nfcClient = new NFCClient(clientUrl.value, { apiSecret: apiSecret.value });

                        nfcClient.on('connected', () => {
                            clientState.value = 'scan';
                            clientConnecting.value = false;
                        });

                        nfcClient.on('disconnected', () => {
                            clientState.value = 'landing';
                            clientConnecting.value = false;
                        });

                        nfcClient.on('error', (err) => {
                            console.error('Client error:', err);
                            clientError.value = err.error?.message || 'Connection error';
                            clientConnecting.value = false;
                        });

                        nfcClient.on('tagData', (data) => {
                            if (data.uid) {
                                handleCard(data);
                            }
                        });

                        nfcClient.on('deviceStatus', (status) => {
                            if (!status.CardPresent && clientState.value === 'card') {
                                clientState.value = 'scan';
                            }
                        });

                        await nfcClient.connect();
                    } catch (err) {
                        console.error('Client connection failed:', err);
                        clientError.value = err.message;
                        clientConnecting.value = false;
                    }
                }

                async function disconnectClient() {
                    if (nfcClient) {
                        await nfcClient.disconnect();
                        nfcClient = null;
                    }
                    clientState.value = 'landing';
                }

                function handleCard(data) {
                    card.uid = data.uid;
                    card.type = data.type || '';
                    card.technology = data.technology || '';
                    card.scannedAt = data.scannedAt;

                    card.records = [];
                    if (data.message && data.message.type === 'ndef' && data.message.records) {
                        card.records = data.message.records;
                    }

                    rawPayload.value = data;

                    writeForm.content = '';
                    writeStatus.message = '';
                    writeStatus.type = '';

                    clientState.value = 'card';
                }

                async function writeCard() {
                    if (!nfcClient || !nfcClient.isConnected()) {
                        writeStatus.message = 'Not connected';
                        writeStatus.type = 'alert-error';
                        return;
                    }

                    const content = writeForm.content.trim();
                    if (!content) return;

                    writeStatus.writing = true;
                    writeStatus.message = 'Writing...';
                    writeStatus.type = 'alert-info';

                    try {
                        const request = {
                            records: [
                                {
                                    type: writeForm.type,
                                    content: content,
                                    language: writeForm.type === 'text' ? 'en' : undefined
                                }
                            ]
                        };

                        await nfcClient.write(request);

                        writeStatus.message = 'Write successful!';
                        writeStatus.type = 'alert-success';
                        writeForm.content = '';

                        setTimeout(() => {
                            writeStatus.message = '';
                            writeStatus.type = '';
                        }, 5000);
                    } catch (err) {
                        console.error('Write error:', err);
                        writeStatus.message = `Error: ${err.message || err}`;
                        writeStatus.type = 'alert-error';

                        setTimeout(() => {
                            writeStatus.message = '';
                            writeStatus.type = '';
                        }, 5000);
                    } finally {
                        writeStatus.writing = false;
                    }
                }

                function backToScan() {
                    clientState.value = 'scan';
                }

                // ==================== Device Mode Functions ====================
                async function connectDevice() {
                    deviceConnecting.value = true;
                    deviceError.value = '';

                    try {
                        deviceClient = new NFCDeviceClient(deviceUrl.value, {
                            deviceName: deviceName.value,
                            platform: 'web',
                            canRead: true,
                            canWrite: true
                        });

                        deviceClient.on('registered', (event) => {
                            deviceID.value = event.deviceID;
                            serverInfo.value = event.serverInfo;
                            deviceState.value = 'connected';
                            deviceConnecting.value = false;
                        });

                        deviceClient.on('disconnected', () => {
                            deviceState.value = 'disconnected';
                            deviceID.value = '';
                            serverInfo.value = null;
                            nfcScanning.value = false;
                        });

                        deviceClient.on('error', (err) => {
                            console.error('Device client error:', err);
                            deviceError.value = err.error?.message || 'Connection error';
                            deviceConnecting.value = false;
                        });

                        deviceClient.on('writeRequest', (req) => {
                            writeRequests.value.unshift(req);
                        });

                        deviceClient.on('nfcReading', (tagData) => {
                            addToScanLog(tagData.uid, 'webnfc');
                            lastScannedUID.value = tagData.uid;
                        });

                        deviceClient.on('nfcReadingError', (err) => {
                            nfcError.value = err.error?.message || 'NFC reading error';
                            setTimeout(() => { nfcError.value = ''; }, 5000);
                        });

                        await deviceClient.connect();
                    } catch (err) {
                        console.error('Device connection failed:', err);
                        deviceError.value = err.message;
                        deviceConnecting.value = false;
                    }
                }

                async function disconnectDevice() {
                    if (deviceClient) {
                        await deviceClient.disconnect();
                        deviceClient = null;
                    }
                    deviceState.value = 'disconnected';
                    deviceID.value = '';
                    serverInfo.value = null;
                    nfcScanning.value = false;
                }

                async function startNFCScanning() {
                    if (!deviceClient) return;

                    try {
                        nfcError.value = '';
                        await deviceClient.startNFCScanning();
                        nfcScanning.value = true;
                    } catch (err) {
                        console.error('Failed to start NFC scanning:', err);
                        nfcError.value = err.message || 'Failed to start NFC scanning';
                    }
                }

                function stopNFCScanning() {
                    if (!deviceClient) return;
                    deviceClient.stopNFCScanning();
                    nfcScanning.value = false;
                }

                async function sendManualScan() {
                    if (!deviceClient || !deviceClient.isConnected()) {
                        deviceError.value = 'Not connected';
                        return;
                    }

                    const uid = manualTag.uid.trim();
                    if (!uid) return;

                    try {
                        const tagData = {
                            uid: uid,
                            type: manualTag.type,
                            technology: manualTag.technology
                        };

                        // Add NDEF message if text provided
                        if (manualTag.ndefText.trim()) {
                            tagData.ndefMessage = {
                                records: [{
                                    recordType: 'text',
                                    content: manualTag.ndefText.trim(),
                                    language: 'en'
                                }]
                            };
                        }

                        await deviceClient.scanTag(tagData);
                        addToScanLog(uid, 'manual');
                        lastScannedUID.value = uid;
                    } catch (err) {
                        console.error('Failed to send tag scan:', err);
                        deviceError.value = err.message;
                    }
                }

                async function sendManualRemove() {
                    if (!deviceClient || !deviceClient.isConnected() || !lastScannedUID.value) {
                        return;
                    }

                    try {
                        await deviceClient.removeTag(lastScannedUID.value);
                        lastScannedUID.value = '';
                    } catch (err) {
                        console.error('Failed to send tag remove:', err);
                        deviceError.value = err.message;
                    }
                }

                async function respondWrite(requestID, success, error = '') {
                    if (!deviceClient) return;

                    try {
                        await deviceClient.respondToWrite(requestID, success, error);
                        writeRequests.value = writeRequests.value.filter(r => r.requestID !== requestID);
                    } catch (err) {
                        console.error('Failed to respond to write:', err);
                    }
                }

                function addToScanLog(uid, source) {
                    const now = new Date();
                    const time = now.toLocaleTimeString();
                    scanLog.value.unshift({ uid, source, time });

                    // Keep only last 20 entries
                    if (scanLog.value.length > 20) {
                        scanLog.value.pop();
                    }
                }

                function clearScanLog() {
                    scanLog.value = [];
                }

                // ==================== Utility Functions ====================
                function formatDate(date) {
                    if (!date) return '';
                    return date.toLocaleString();
                }

                // Check WebNFC support on mount
                onMounted(() => {
                    webNFCSupported.value = NFCDeviceClient.isWebNFCSupported();
                });

                return {
                    // Mode
                    mode,
                    switchMode,

                    // Client mode
                    clientState,
                    clientUrl,
                    apiSecret,
                    clientConnecting,
                    clientError,
                    card,
                    rawPayload,
                    writeForm,
                    writeStatus,
                    connectClient,
                    disconnectClient,
                    writeCard,
                    backToScan,

                    // Device mode
                    deviceState,
                    deviceUrl,
                    deviceName,
                    deviceConnecting,
                    deviceError,
                    deviceID,
                    serverInfo,
                    webNFCSupported,
                    nfcScanning,
                    nfcError,
                    manualTag,
                    lastScannedUID,
                    writeRequests,
                    scanLog,
                    connectDevice,
                    disconnectDevice,
                    startNFCScanning,
                    stopNFCScanning,
                    sendManualScan,
                    sendManualRemove,
                    respondWrite,
                    clearScanLog,

                    // Utility
                    formatDate
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
